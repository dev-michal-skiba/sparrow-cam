volumes:
  hls_data:
  annotations_data:

services:
  processor:
    build:
      context: ..
      dockerfile: local/Dockerfile.processor
    container_name: sparrow_cam_processor
    environment:
      - OPENCV_LOG_LEVEL=${OPENCV_LOG_LEVEL:-ERROR}
      - OPENCV_VIDEOIO_DEBUG=${OPENCV_VIDEOIO_DEBUG:-0}
    ports:
      - "5000:5000"
    volumes:
      - ../app/processor/:/app/
      - hls_data:/var/www/html/hls
      - annotations_data:/var/www/html/annotations
      - ./.archive:/var/www/html/storage/sparrow_cam/archive
      - ../deploy/ansible/ssh_key:/secrets/ssh_key:ro
      - ../deploy/ansible/group_vars/all.yml:/secrets/all.yml:ro

  web:
    build:
      context: ..
      dockerfile: local/Dockerfile.web
      args:
        WEB_PORT: 8080
    container_name: sparrow_cam_web
    depends_on:
      processor:
        condition: service_started
    ports:
      - "8080:8080"
    volumes:
      - ../app/index.html:/var/www/html/index.html
      - ../app/icon.png:/var/www/html/icon.png
      - hls_data:/var/www/html/hls
      - annotations_data:/var/www/html/annotations
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:$$WEB_PORT >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
