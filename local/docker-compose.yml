volumes:
  hls_data:
  processed_hls_data:

services:
  sparrow-cam:
    build:
      context: ..
      dockerfile: local/Dockerfile
      args:
        WEB_PORT: 8080
        RTMP_PORT: 8081
    container_name: sparrow_cam_local
    environment:
      - WEB_PORT=8080
      - RTMP_PORT=8081
    ports:
      - "8080:8080"  # Web server
      - "8081:8081"  # RTMP server
    volumes:
      - ../app/index.html:/var/www/html/index.html
      - hls_data:/var/www/html/hls
      - processed_hls_data:/var/www/html/processed_hls
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'nc -z localhost $$RTMP_PORT || curl -fsS http://localhost:$$WEB_PORT >/dev/null'"]
      interval: 5s
      timeout: 3s
      retries: 20

  processor:
    build:
      context: ..
      dockerfile: local/Dockerfile.processor
    container_name: sparrow_cam_processor
    depends_on:
      sparrow-cam:
        condition: service_healthy
    environment:
      - OPENCV_LOG_LEVEL=${OPENCV_LOG_LEVEL:-ERROR}
      - OPENCV_VIDEOIO_DEBUG=${OPENCV_VIDEOIO_DEBUG:-0}
    ports:
      - "5000:5000"
    volumes:
      - ../app/processor/:/app/
      - hls_data:/var/www/html/hls
      - processed_hls_data:/var/www/html/processed_hls
