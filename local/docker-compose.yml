volumes:
  hls_data:
  annotations_data:

services:
  rtmp:
    build:
      context: ..
      dockerfile: local/Dockerfile.rtmp
      args:
        RTMP_PORT: 8081
    container_name: sparrow_cam_rtmp
    ports:
      - "8081:8081"
    volumes:
      - hls_data:/var/www/html/hls
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost $$RTMP_PORT"]
      interval: 5s
      timeout: 3s
      retries: 20

  processor:
    build:
      context: ..
      dockerfile: local/Dockerfile.processor
    container_name: sparrow_cam_processor
    depends_on:
      rtmp:
        condition: service_healthy
    environment:
      - OPENCV_LOG_LEVEL=${OPENCV_LOG_LEVEL:-ERROR}
      - OPENCV_VIDEOIO_DEBUG=${OPENCV_VIDEOIO_DEBUG:-0}
    ports:
      - "5000:5000"
    volumes:
      - ../app/processor/:/app/
      - hls_data:/var/www/html/hls
      - annotations_data:/var/www/html/annotations

  web:
    build:
      context: ..
      dockerfile: local/Dockerfile.web
      args:
        WEB_PORT: 8080
    container_name: sparrow_cam_web
    depends_on:
      processor:
        condition: service_started
    ports:
      - "8080:8080"
    volumes:
      - ../app/index.html:/var/www/html/index.html
      - hls_data:/var/www/html/hls
      - annotations_data:/var/www/html/annotations
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:$$WEB_PORT >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
