---
- name: Deploy Processor Service
  hosts: all
  become: yes
  vars:
    processor_python_version: "3.11.13"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install build dependencies for pyenv and Python packages
      apt:
        name:
          - build-essential
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - curl
          - git
          - libncursesw5-dev
          - xz-utils
          - libffi-dev
          - liblzma-dev
          - libgl1
          - libglib2.0-0
          - acl
        state: present

    - name: Create annotations directory
      file:
        path: /var/www/html/annotations
        state: directory
        owner: sparrow_cam_processor
        group: www-data
        mode: '0775'

    - name: Create stream archive storage directory
      file:
        path: /var/www/html/storage/sparrow_cam/archive
        state: directory
        owner: sparrow_cam_processor
        group: www-data
        mode: '0775'

    - name: Create temp directory for sparrow_cam_processor
      file:
        path: /opt/sparrow_cam_processor/tmp
        state: directory
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0700'

    - name: Check if pyenv is already installed for sparrow_cam_processor
      stat:
        path: /opt/sparrow_cam_processor/.pyenv
      register: pyenv_installed

    - name: Install pyenv for sparrow_cam_processor user
      shell: curl https://pyenv.run | bash
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        TMPDIR: /opt/sparrow_cam_processor/tmp
      when: not pyenv_installed.stat.exists

    - name: Create pyenv initialization script
      copy:
        content: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          eval "$(pyenv virtualenv-init -)"
        dest: /opt/sparrow_cam_processor/.pyenvrc
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0644'

    - name: Setup pyenv in .bashrc for sparrow_cam_processor
      blockinfile:
        path: /opt/sparrow_cam_processor/.bashrc
        block: |
          # Load pyenv configuration
          if [ -f "$HOME/.pyenvrc" ]; then
            source "$HOME/.pyenvrc"
          fi
        marker: "# {mark} ANSIBLE MANAGED BLOCK - PYENV"
        create: yes
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0644'

    - name: Check if Python {{ processor_python_version }} is already installed
      stat:
        path: /opt/sparrow_cam_processor/.pyenv/versions/{{ processor_python_version }}
      register: python_version_installed

    - name: Install Python {{ processor_python_version }} via pyenv
      shell: |
        source ~/.pyenvrc
        pyenv install {{ processor_python_version }}
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        PYENV_ROOT: /opt/sparrow_cam_processor/.pyenv
        TMPDIR: /opt/sparrow_cam_processor/tmp
      when: not python_version_installed.stat.exists

    - name: Check current Python version of sparrow_cam_processor virtualenv
      shell: |
        source ~/.pyenvrc
        venv_path=$(find "$PYENV_ROOT/versions" -maxdepth 3 -type d -path "*/envs/sparrow_cam_processor" -print -quit)
        if [ -n "$venv_path" ]; then
          basename "$(dirname "$(dirname "$venv_path")")"
        else
          echo "none"
        fi
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        PYENV_ROOT: /opt/sparrow_cam_processor/.pyenv
      register: current_venv_python
      changed_when: false

    - name: Remove old sparrow_cam_processor virtualenv if Python version changed
      shell: |
        source ~/.pyenvrc
        pyenv uninstall -f sparrow_cam_processor
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        PYENV_ROOT: /opt/sparrow_cam_processor/.pyenv
      when:
        - current_venv_python.stdout != "none"
        - current_venv_python.stdout != processor_python_version

    - name: Create sparrow_cam_processor virtual environment with Python {{ processor_python_version }}
      shell: |
        source ~/.pyenvrc
        pyenv virtualenv {{ processor_python_version }} sparrow_cam_processor
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        PYENV_ROOT: /opt/sparrow_cam_processor/.pyenv
      when:
        - current_venv_python.stdout == "none" or current_venv_python.stdout != processor_python_version

    - name: Create processor app directory
      file:
        path: /opt/sparrow_cam_processor/apps
        state: directory
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0755'

    - name: Clean processor app directory if it exists
      file:
        path: /opt/sparrow_cam_processor/apps/processor
        state: absent

    - name: Copy processor application files
      copy:
        src: /app/processor/processor/
        dest: /opt/sparrow_cam_processor/apps/processor/processor
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0755'
        directory_mode: '0755'
      notify: reload and restart processor

    - name: Clean __pycache__ from deployed processor
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /opt/sparrow_cam_processor/apps/processor/processor/__pycache__
        - /opt/sparrow_cam_processor/apps/processor/tests/__pycache__

    - name: Copy processor .toml file
      copy:
        src: /app/processor/pyproject.toml
        dest: /opt/sparrow_cam_processor/apps/processor/pyproject.toml
        owner: sparrow_cam_processor
        group: sparrow_cam_processor
        mode: '0644'
      notify: reload and restart processor

    - name: Install processor app with dependencies
      shell: |
        source ~/.pyenvrc
        pyenv activate sparrow_cam_processor
        pip install --upgrade pip setuptools wheel
        pip install -e /opt/sparrow_cam_processor/apps/processor
      args:
        executable: /bin/bash
      become: yes
      become_user: sparrow_cam_processor
      environment:
        HOME: /opt/sparrow_cam_processor
        PYENV_ROOT: /opt/sparrow_cam_processor/.pyenv
      notify: reload and restart processor

    - name: Create processor systemd service file
      copy:
        content: |
          [Unit]
          Description=SparrowCam HLS Segment Processor
          After=network.target nginx.service nginx-rtmp.service
          Wants=nginx.service nginx-rtmp.service

          [Service]
          Type=simple
          User=sparrow_cam_processor
          Group=sparrow_cam_processor
          WorkingDirectory=/opt/sparrow_cam_processor/apps/processor
          Environment="PATH=/opt/sparrow_cam_processor/.pyenv/versions/sparrow_cam_processor/bin:/opt/sparrow_cam_processor/.pyenv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          Environment="HOME=/opt/sparrow_cam_processor"
          Environment="PYENV_ROOT=/opt/sparrow_cam_processor/.pyenv"
          Environment="PYTHONUNBUFFERED=1"
          ExecStart=/opt/sparrow_cam_processor/.pyenv/versions/sparrow_cam_processor/bin/python -m processor
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=sparrow-processor

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/sparrow-processor.service
        owner: root
        group: root
        mode: '0644'
      notify: reload and restart processor

    - name: Enable processor service to start on boot
      systemd:
        name: sparrow-processor
        enabled: yes
        daemon_reload: yes

    - name: Start processor service
      systemd:
        name: sparrow-processor
        state: started
        daemon_reload: yes

  handlers:
    - name: reload and restart processor
      systemd:
        name: sparrow-processor
        state: restarted
        daemon_reload: yes
