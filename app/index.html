<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pi RTMP â†’ HLS player</title>
</head>
<body>
  <h1>Live Stream</h1>
  <video id="video" controls autoplay playsinline style="width: 80%; max-width: 900px;"></video>
  <p>If your browser doesn't natively play HLS, hls.js will handle playback.</p>

  <h2>Recordings</h2>
  <p>Click <a href="/recordings/">here</a> to browse saved recordings.</p>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    const hlsUrl = '/hls/sparrow_cam.m3u8'; // playlist generated by nginx-rtmp

    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = hlsUrl;
    } else if (Hls.isSupported()) {
      // Configure HLS.js for smooth live streaming (YouTube-like experience)
      const hls = new Hls({
        // Low latency live streaming
        liveSyncDuration: 3,        // Stay 3 seconds behind live edge
        liveMaxLatencyDuration: 8,  // Max 8 seconds behind, then catch up
        liveDurationInfinity: true, // Treat as infinite live stream
        highBufferWatchdogPeriod: 1,

        // Smooth playback
        maxBufferLength: 10,        // 10 seconds buffer
        maxMaxBufferLength: 20,     // Max 20 seconds buffer
        maxBufferSize: 60 * 1000 * 1000, // 60 MB

        // Quick start
        maxBufferHole: 0.5,
        nudgeMaxRetry: 3
      });

      hls.loadSource(hlsUrl);
      hls.attachMedia(video);

      // Auto-play when loaded
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play();
      });
    } else {
      video.innerHTML = 'HLS not supported in this browser.';
    }
  </script>
</body>
</html>
