<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pi RTMP â†’ HLS player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .streams-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .stream-box {
      flex: 1;
      min-width: 400px;
    }
    .stream-box h2 {
      margin-top: 0;
    }
    video, img {
      width: 100%;
      max-width: 640px;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Live Stream</h1>

  <div class="streams-container">
    <div class="stream-box">
      <h2>HLS Stream (Processed)</h2>
      <video id="video" controls autoplay playsinline></video>
      <p>Processed video stream (flipped upside down) from the processor service.</p>
    </div>

    <div class="stream-box">
      <h2>HLS Stream (Original)</h2>
      <video id="video-original" controls autoplay playsinline></video>
      <p>Original unprocessed HLS stream from nginx-rtmp.</p>
    </div>
  </div>

  <h2>Recordings</h2>
  <p>Click <a href="/recordings/">here</a> to browse saved recordings.</p>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    function setupHLS(videoElementId, playlistUrl, description) {
      const video = document.getElementById(videoElementId);

      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = playlistUrl;
      } else if (Hls.isSupported()) {
        // Configure HLS.js for stable, smooth streaming with better buffering
        const hls = new Hls({
          // Stable live streaming with acceptable latency
          liveSyncDuration: 9,        // Stay ~9 seconds behind live edge for stability
          liveMaxLatencyDuration: 20, // Allow up to 20 seconds before catch-up
          liveDurationInfinity: true, // Treat as infinite live stream
          highBufferWatchdogPeriod: 2,
          liveBackBufferLength: 30,   // Keep 30s of back buffer for seeking

          // Generous buffering for smooth playback
          maxBufferLength: 30,        // 30 seconds forward buffer
          maxMaxBufferLength: 60,     // Max 60 seconds buffer
          maxBufferSize: 120 * 1000 * 1000, // 120 MB

          // Tolerant playback settings
          maxBufferHole: 1.0,         // More tolerant of gaps
          nudgeMaxRetry: 5,           // More retries before giving up
          maxFragLookUpTolerance: 1.0,

          // Smoother startup
          startLevel: -1,             // Auto quality selection
          abrEwmaDefaultEstimate: 500000 // Conservative bandwidth estimate
        });

        hls.loadSource(playlistUrl);
        hls.attachMedia(video);

        // Auto-play when loaded
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error(`HLS Error (${description}):`, data);
        });
      } else {
        video.innerHTML = 'HLS not supported in this browser.';
      }
    }

    // Setup processed stream (from processor service)
    setupHLS('video', '/processed_hls/sparrow_cam.m3u8', 'processed');

    // Setup original stream (from nginx-rtmp)
    setupHLS('video-original', '/hls/sparrow_cam.m3u8', 'original');
  </script>
</body>
</html>
